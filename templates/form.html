<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรับเรื่องร้องเรียน - ฟอร์ม</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('fda_scan.static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('fda_scan.static', filename='favicon.ico') }}">
    <style>
        /* CSS เดิม */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .container {
            max-width: 600px;
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-left: auto;
            margin-right: auto;
        }

        .page-header {
            position: relative;
            text-align: center;
            margin-bottom: 30px; /* ระยะห่างเดิมของ h1 */
        }
        .back-button {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            text-decoration: none;
            color: #6c757d;
            background-color: #f8f9fa;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }
        .back-button:hover {
            background-color: #e9ecef;
            color: #212529;
        }

        h1 {
            color: #007bff;
            font-weight: 600;
            margin-top: 0;
            padding: 0 50px;
        }
        .form-group label {
            font-weight: 500;
            color: #343a40;
            margin-bottom: 5px;
        }
        .form-control {
            border-radius: 5px;
            border: 1px solid #ced4da;
            padding: 10px 12px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            /* START: เพิ่ม CSS เพื่อให้แสดงข้อความเต็ม */
            height: auto; 
            /* END: เพิ่ม CSS */
        }
        .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        /* START: ทำให้ช่องที่ readonly มีพื้นหลังสีเทาอ่อนเพื่อบ่งบอกผู้ใช้ */
        .form-control[readonly] {
            background-color: #e9ecef;
            opacity: 1;
        }
        /* END: CSS เพิ่มเติม */
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            padding: 10px 20px;
            font-size: 1.1rem;
            border-radius: 5px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .text-center {
            text-align: center;
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px auto;
            }
            h1 {
                font-size: 1.8rem;
            }
            .back-button { /* เพิ่มส่วนนี้เข้าไป */
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }
        }
        @media (max-width: 480px) {
            .container {
                padding: 10px;
                margin: 5px auto;
            }
            h1 {
                font-size: 1.6rem;
                padding: 0 45px;
            }
        }

        /* CSS ใหม่สำหรับส่วนอัปโหลดรูปภาพ (ใช้ร่วมกันทั้งสองส่วน) */
        .file-upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        .file-upload-plus-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100px;
            height: 100px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .file-upload-plus-icon:hover {
            background-color: #f0f0f0;
        }
        .file-upload-plus-icon .plus-icon {
            font-size: 3rem;
            color: #007bff;
        }
        .file-input {
            display: none;
        }
        .file-upload-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .file-upload-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .file-upload-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            cursor: pointer;
        }
        .scanned-image-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
            text-align: center;
        }
        .scanned-image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scanned-image-container p {
            margin-top: 10px;
            font-weight: bold;
            color: #555;
        }
        #loading-overlay {
            position: fixed; /* แสดงทับเต็มจอ */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95); /* พื้นหลังสีขาวโปร่งแสง */
            z-index: 9999; /* ให้อยู่หน้าสุด */
            display: none; /* ซ่อนไว้ก่อน */
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
            font-family: 'Kanit', sans-serif;
        }
        .progress-circle {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(#007bff 0deg, #e9ecef 0deg);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            transition: background 0.2s;
        }
        .progress-circle::before {
            content: '';
            position: absolute;
            width: 130px;
            height: 130px;
            background-color: #fff;
            border-radius: 50%;
        }
        #progress-percent {
            position: relative;
            font-size: 2.5rem;
            font-weight: 600;
            color: #007bff;
        }
        #loading-text {
            font-size: 1.2rem;
            color: #343a40;
            font-weight: 500;
        }
        /* CSS ใหม่สำหรับหมายเหตุท้ายฟอร์ม */
        .form-note {
            font-size: 0.85rem; /* ทำให้ตัวอักษรเล็กลงเล็กน้อย */
            color: #6c757d; /* สีเทา ทำให้ดูเป็นข้อความเสริม */
            margin-top: 20px; /* เพิ่มระยะห่างจากช่องกรอกข้อมูลด้านบน */
            margin-bottom: 15px; /* เพิ่มระยะห่างจากปุ่มส่ง */
            line-height: 1.5; /* เพิ่มความสูงระหว่างบรรทัดให้อ่านง่าย */
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <a href="#" onclick="history.back(); return false;" class="back-button" aria-label="กลับไปหน้าหลัก">⬅️</a>
            <h1>แจ้งเรื่องร้องเรียนผลิตภัณฑ์</h1>
        </div>
        <form id="complaint-form" action="/fda_scan/form" method="POST" enctype="multipart/form-data">
            
            <input type="hidden" id="scanned_image_hidden_input" name="scanned_image" value="{{ scanned_image or '' }}">

            <div class="form-group">
                <label for="com_name">ชื่อจริง</label>
                <input type="text" class="form-control" id="com_name" name="com_name" value="{{ user_data.get('com_name', '') }}" required>
            </div>
            <div class="form-group">
                <label for="com_surname">นามสกุล</label>
                <input type="text" class="form-control" id="com_surname" name="com_surname" value="{{ user_data.get('com_surname', '') }}" required>
            </div>

            <div class="form-group">
                <label for="com_tel">เบอร์โทรศัพท์</label>
                <input type="tel" class="form-control" id="com_tel" name="com_tel" value="{{ user_data.get('com_tel', '') }}" required placeholder="0XX-XXX-XXXX" maxlength="12">
            </div>

            <div class="form-group">
                <label for="com_email">อีเมล</label>
                <input type="email" class="form-control" id="com_email" name="com_email" value="{{ user_data.get('com_email', '') }}" required placeholder="fda123@gmail.com">
            </div>

            <div class="form-group">
                <label for="com_code">เลขผลิตภัณฑ์ 13 หลัก</label>
                <input type="text" class="form-control" id="com_code" name="com_code" value="{{ com_code or '' }}" placeholder="กรอกเลขผลิตภัณฑ์ 13 หลักด้วยตนเอง" maxlength="17" required {% if is_from_scan %}readonly{% endif %}>
            </div>

            <div class="form-group">
                <label for="fdatype">หมวดหมู่ผลิตภัณฑ์</label>
                <select class="form-control" id="fdatype" name="fdatype" required>
                    <option value="">เลือกหมวดหมู่</option>
                </select>
            </div>

            <p style="font-weight: bold; margin-bottom: 10px;">สถานที่พบผลิตภัณฑ์</p>
            <div class="form-group">
                <label for="com_geographies">ภูมิภาค</label>
                <!-- START: แก้ไข name attribute -->
                <select class="form-control" id="com_geographies" name="com_geographies" required>
                <!-- END: แก้ไข -->
                    <option value="">เลือกภูมิภาค</option>
                </select>
            </div>
            <div class="form-group">
                <label for="province">จังหวัด</label>
                <!-- START: แก้ไข name attribute -->
                <select class="form-control" id="province" name="province" required disabled>
                <!-- END: แก้ไข -->
                    <option value="">เลือกจังหวัด</option>
                </select>
            </div>
            <div class="form-group">
                <label for="district">อำเภอ</label>
                <!-- START: แก้ไข name attribute -->
                <select class="form-control" id="district" name="district" required disabled>
                <!-- END: แก้ไข -->
                    <option value="">เลือกอำเภอ</option>
                </select>
            </div>
            <div class="form-group">
                <label for="subdistrict">ตำบล</label>
                <!-- START: แก้ไข name attribute -->
                <select class="form-control" id="subdistrict" name="subdistrict" required disabled>
                <!-- END: แก้ไข -->
                    <option value="">เลือกตำบล</option>
                </select>
            </div>

            <div class="form-group">
                <label for="source">แหล่งที่มา</label>
                <input type="text" class="form-control" id="source" name="source" value="{{ user_data.get('source', '') }}" required placeholder="เช่น ร้านสะดวกซื้อ, แถวห้าง, อื่นๆ">
            </div>

            <div class="form-group">
                <label for="com_reported">เพราะเหตุใดถึงรายงาน</label>
                <textarea class="form-control" id="com_reported" name="com_reported" rows="3" required placeholder="เช่น มีการปลอมแปลงเลขผลิตภัณฑ์, สินค้าหมดอายุ, ลักษณะผิดปกติ"></textarea>
            </div>
            
            <div class="form-group">
                <label for="com_fda_real_data">ข้อมูลจากแหล่งตรวจสอบ อย.</label>
                <textarea class="form-control" id="com_fda_data" name="com_fda_data" rows="4" placeholder="ระบุข้อมูลที่ปรากฏบนฉลากผลิตภัณฑ์จริง (เช่น ชื่อผลิตภัณฑ์, ผลิตโดย)" {% if is_from_scan %}readonly{% endif %}>{{ com_fda_real_data or '' }}</textarea>
            </div>

            <div class="form-group">
                <label>รูปภาพจากการสแกน</label>
                <div id="imageUploadArea" class="file-upload-grid">
                    </div>
            </div>

            <div class="form-group">
                <label>เพิ่มรูปภาพที่ต้องการรายงาน (สูงสุด 4 รูปภาพ)</label>
                <div id="reportImageUploadArea" class="file-upload-grid">
                    <!-- พื้นที่สำหรับแสดงรูปและปุ่มบวกจะถูกสร้างโดย JavaScript -->
                </div>
            </div>

            <div class="text-center">
                <p class="form-note">
                    *หมายเหตุ: ฟอร์มการส่งคำร้องเรียนนี้ จะส่งไปยังผู้ใช้งานที่กรอกอีเมล และสำนักงานคณะกรรมการอาหารและยาโดยตรงผ่านทางอีเมล
                </p>
                <button type="submit" class="btn btn-primary">ส่งคำร้องเรียนผลิตภัณฑ์</button>
            </div>
        </form>

        <div id="scannedImageDisplay" class="scanned-image-container" style="display:none;">
            <p>รูปภาพจากหน้าสแกน:</p>
            <img id="scannedImagePreview" src="" alt="Scanned Image">
        </div>
        </div>

        <div id="loading-overlay">
            <div class="progress-circle" id="progress-circle">
                <span id="progress-percent">0%</span>
            </div>
            <div id="loading-text">
                <p>กำลังส่งคำร้องเรียนของคุณ...</p>
                <p>ระบบกำลังสร้างไฟล์ PDF และส่งอีเมล กรุณารอสักครู่</p>
            </div>
        </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // โค้ดสำหรับ Dropdown ต่างๆ (โค้ดเดิม)
            const geographySelect = document.getElementById('com_geographies');
            const provinceSelect = document.getElementById('province');
            const districtSelect = document.getElementById('district');
            const subdistrictSelect = document.getElementById('subdistrict');
            const fdaTypeSelect = document.getElementById('fdatype');

            // START: แก้ไข ลบตัวแปรของ hidden input ที่ไม่ใช้ออก
            // const geographyNameInput = document.getElementById('com_geographies_name');
            // const provinceNameInput = document.getElementById('province_name');
            // const districtNameInput = document.getElementById('district_name');
            // const subdistrictNameInput = document.getElementById('subdistrict_name');
            // END: แก้ไข

            const complaintForm = document.getElementById('complaint-form');
            const loadingOverlay = document.getElementById('loading-overlay');
            const progressCircle = document.getElementById('progress-circle');
            const progressPercent = document.getElementById('progress-percent');
            
            function populateDropdown(selectElement, data, placeholder) {
                selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name_th || item.name;
                    selectElement.appendChild(option);
                });
                selectElement.disabled = false;
            }

            fetch('/fda_scan/static/thai-data/fdatype.json')
                .then(response => response.json())
                .then(data => {
                    populateDropdown(fdaTypeSelect, data, 'เลือกหมวดหมู่');
                })
                .catch(error => console.error('Error loading FDA types:', error));

            fetch('/fda_scan/get_geographies')
                .then(response => response.json())
                .then(data => {
                    populateDropdown(geographySelect, data, 'เลือกภูมิภาค');
                })
                .catch(error => console.error('Error loading geographies:', error));

            geographySelect.addEventListener('change', function() {
                const selectedGeogId = this.value;
                // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                // const selectedGeogName = this.options[this.selectedIndex].textContent;
                // geographyNameInput.value = selectedGeogName;
                // END: แก้ไข

                if (selectedGeogId) {
                    fetch(`/fda_scan/get_provinces/${selectedGeogId}`)
                        .then(response => response.json())
                        .then(data => {
                            populateDropdown(provinceSelect, data, '-- เลือกจังหวัด --');
                            populateDropdown(districtSelect, [], '-- เลือกอำเภอ --');
                            districtSelect.disabled = true;
                            populateDropdown(subdistrictSelect, [], '-- เลือกตำบล --');
                            subdistrictSelect.disabled = true;
                            // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                            // provinceNameInput.value = '';
                            // districtNameInput.value = '';
                            // subdistrictNameInput.value = '';
                            // END: แก้ไข
                        })
                        .catch(error => console.error('Error loading provinces:', error));
                } else {
                    populateDropdown(provinceSelect, [], '-- เลือกจังหวัด --');
                    provinceSelect.disabled = true;
                    populateDropdown(districtSelect, [], '-- เลือกอำเภอ --');
                    districtSelect.disabled = true;
                    populateDropdown(subdistrictSelect, [], '-- เลือกตำบล --');
                    subdistrictSelect.disabled = true;
                    // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                    // geographyNameInput.value = '';
                    // provinceNameInput.value = '';
                    // districtNameInput.value = '';
                    // subdistrictNameInput.value = '';
                    // END: แก้ไข
                }
            });

            provinceSelect.addEventListener('change', function() {
                const selectedProvinceId = this.value;
                // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                // const selectedProvinceName = this.options[this.selectedIndex].textContent;
                // provinceNameInput.value = selectedProvinceName;
                // END: แก้ไข

                if (selectedProvinceId) {
                    fetch(`/fda_scan/get_amphures/${selectedProvinceId}`)
                        .then(response => response.json())
                        .then(data => {
                            populateDropdown(districtSelect, data, '-- เลือกอำเภอ --');
                            populateDropdown(subdistrictSelect, [], '-- เลือกตำบล --');
                            subdistrictSelect.disabled = true;
                            // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                            // districtNameInput.value = '';
                            // subdistrictNameInput.value = '';
                            // END: แก้ไข
                        })
                        .catch(error => console.error('Error loading amphures:', error));
                } else {
                    populateDropdown(districtSelect, [], '-- เลือกอำเภอ --');
                    districtSelect.disabled = true;
                    populateDropdown(subdistrictSelect, [], '-- เลือกตำบล --');
                    subdistrictSelect.disabled = true;
                    // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                    // provinceNameInput.value = '';
                    // districtNameInput.value = '';
                    // subdistrictNameInput.value = '';
                    // END: แก้ไข
                }
            });

            districtSelect.addEventListener('change', function() {
                const selectedDistrictId = this.value;
                // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                // const selectedDistrictName = this.options[this.selectedIndex].textContent;
                // districtNameInput.value = selectedDistrictName;
                // END: แก้ไข

                if (selectedDistrictId) {
                    fetch(`/fda_scan/get_tambons/${selectedDistrictId}`)
                        .then(response => response.json())
                        .then(data => {
                            populateDropdown(subdistrictSelect, data, '-- เลือกตำบล --');
                            // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                            // subdistrictNameInput.value = '';
                            // END: แก้ไข
                        })
                        .catch(error => console.error('Error loading tambons:', error));
                } else {
                    populateDropdown(subdistrictSelect, [], '-- เลือกตำบล --');
                    subdistrictSelect.disabled = true;
                    // START: แก้ไข ลบบรรทัดที่เกี่ยวกับ hidden input ออก
                    // districtNameInput.value = '';
                    // subdistrictNameInput.value = '';
                    // END: แก้ไข
                }
            });

            // START: แก้ไข ลบ event listener ของ subdistrict ที่ไม่จำเป็นแล้ว
            // subdistrictSelect.addEventListener('change', function() {
            //     const selectedOption = this.options[this.selectedIndex];
            //     const selectedSubdistrictName = selectedOption.textContent;
            //     subdistrictNameInput.value = selectedSubdistrictName;
            // });
            // END: แก้ไข
            
            // --- ส่วนอัปโหลดรูปภาพ (โค้ดเดิม) ---
            const imageUploadArea = document.getElementById('imageUploadArea');
            let uploadedFiles = [];
            const maxImages = 5;
            
            const scannedImageHiddenInput = document.getElementById('scanned_image_hidden_input');
            const scannedImageFilename = scannedImageHiddenInput ? scannedImageHiddenInput.value : null;

            if (scannedImageFilename) {
                uploadedFiles.push(scannedImageFilename);
            }
            
            function renderUploadElements() {
                imageUploadArea.innerHTML = '';
                
                uploadedFiles.forEach((file, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'file-upload-preview-item';
                    
                    let imageUrl = '';
                    if (typeof file === 'string') {
                        imageUrl = `/fda_scan/images/${file}`;
                    } else {
                        imageUrl = URL.createObjectURL(file);
                    }
                    
                    previewItem.innerHTML = `<img src="${imageUrl}" alt="Preview">
                                             <span class="remove-btn" data-index="${index}">&times;</span>`;
                    imageUploadArea.appendChild(previewItem);
                });
                
                if (uploadedFiles.length < maxImages) {
                    const fileInputId = `image_input_${uploadedFiles.length}`;
                    const plusIcon = document.createElement('label');
                    plusIcon.setAttribute('for', fileInputId);
                    
                    

                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.className = 'file-input';
                    fileInput.id = fileInputId;
                    fileInput.name = 'images[]';
                    fileInput.accept = 'image/*';
                    fileInput.multiple = 'multiple';

                    imageUploadArea.appendChild(plusIcon);
                    imageUploadArea.appendChild(fileInput);
                }
            }

            function updateHiddenInputs() {
                const form = document.querySelector('form');
                const existingHiddenInputs = form.querySelectorAll('input[name="images[]"][type="hidden"]');
                existingHiddenInputs.forEach(input => form.removeChild(input));
                
                uploadedFiles.forEach(file => {
                    if (typeof file === 'string') {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'images[]';
                        hiddenInput.value = file;
                        form.appendChild(hiddenInput);
                    }
                });
            }

            imageUploadArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-btn')) {
                    const index = e.target.getAttribute('data-index');
                    uploadedFiles.splice(index, 1);
                    renderUploadElements();
                }
            });

            document.querySelector('form').addEventListener('change', function(e) {
                if (e.target.type === 'file' && e.target.files.length > 0 && e.target.name === 'images[]') {
                    const files = Array.from(e.target.files);
                    const newFiles = files.slice(0, maxImages - uploadedFiles.length);
                    
                    newFiles.forEach(file => {
                        uploadedFiles.push(file);
                    });
                    
                    renderUploadElements();
                }
            });

            renderUploadElements();

            const phoneInput = document.getElementById('com_tel');
            phoneInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 10) {
                    value = value.slice(0, 10);
                }
                
                let formattedValue = '';
                if (value.length > 6) {
                    formattedValue = `${value.slice(0, 3)}-${value.slice(3, 6)}-${value.slice(6)}`;
                } else if (value.length > 3) {
                    formattedValue = `${value.slice(0, 3)}-${value.slice(3)}`;
                } else {
                    formattedValue = value;
                }
                e.target.value = formattedValue;
            });

            // โค้ดสำหรับ "เพิ่มรูปที่ต้องการรายงาน" (โค้ดเดิม)
            const reportImageUploadArea = document.getElementById('reportImageUploadArea');
            let reportUploadedFiles = []; 
            const maxReportImages = 4;

            function renderReportUploadElements() {
                reportImageUploadArea.innerHTML = '';
                
                reportUploadedFiles.forEach((file, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'file-upload-preview-item';
                    const imageUrl = URL.createObjectURL(file);
                    
                    previewItem.innerHTML = `<img src="${imageUrl}" alt="Report Preview">
                                             <span class="remove-btn report-remove-btn" data-index="${index}">&times;</span>`;
                    reportImageUploadArea.appendChild(previewItem);
                });
                
                if (reportUploadedFiles.length < maxReportImages) {
                    const fileInputId = `report_image_input_${reportUploadedFiles.length}`;
                    const plusIcon = document.createElement('label');
                    plusIcon.setAttribute('for', fileInputId);
                    plusIcon.className = 'file-upload-plus-icon';
                    plusIcon.innerHTML = `<span class="plus-icon">+</span>`;

                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.className = 'file-input';
                    fileInput.id = fileInputId;
                    fileInput.name = 'report_images_temp'; 
                    fileInput.accept = 'image/*';
                    fileInput.multiple = true; 

                    reportImageUploadArea.appendChild(plusIcon);
                    reportImageUploadArea.appendChild(fileInput);
                }
            }

            reportImageUploadArea.addEventListener('change', function(e) {
                if (e.target.type === 'file' && e.target.files.length > 0) {
                    const files = Array.from(e.target.files);
                    const spaceLeft = maxReportImages - reportUploadedFiles.length;
                    
                    if (files.length > spaceLeft) {
                        alert(`คุณสามารถเพิ่มรูปได้อีก ${spaceLeft} รูปเท่านั้น`);
                    }

                    const newFiles = files.slice(0, spaceLeft);
                    
                    newFiles.forEach(file => {
                        reportUploadedFiles.push(file);
                    });
                    
                    renderReportUploadElements();
                }
            });

            reportImageUploadArea.addEventListener('click', function(e) {
                if (e.target.classList.contains('report-remove-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'), 10);
                    reportUploadedFiles.splice(index, 1);
                    renderReportUploadElements();
                }
            });

            renderReportUploadElements();


            // จัดการ Form Submission
            document.querySelector('form').addEventListener('submit', function(e) {
                updateHiddenInputs();

                const tempInputs = document.querySelectorAll('input[name="report_images_temp"]');
                tempInputs.forEach(input => input.remove());
                
                const dataTransfer = new DataTransfer();
                reportUploadedFiles.forEach(file => {
                    dataTransfer.items.add(file);
                });

                const finalReportInput = document.createElement('input');
                finalReportInput.type = 'file';
                finalReportInput.name = 'report_images';
                finalReportInput.files = dataTransfer.files;
                finalReportInput.style.display = 'none';
                finalReportInput.multiple = true;

                this.appendChild(finalReportInput);
            });
            
            // --- โค้ดใหม่สำหรับปรับความสูง Textarea อัตโนมัติ ---
            const fdaDataTextarea = document.getElementById('com_fda_data');

            function adjustTextareaHeight(textarea) {
                if (textarea) {
                    textarea.style.height = 'auto'; 
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                }
            }

            adjustTextareaHeight(fdaDataTextarea);
            
            complaintForm.addEventListener('submit', function(event) {
                if (!complaintForm.checkValidity()) {
                    complaintForm.reportValidity();
                    event.preventDefault();
                    return;
                }

                event.preventDefault(); 
                loadingOverlay.style.display = 'flex'; 

                let progress = 0;
                const interval = setInterval(() => {
                    if (progress < 99) {
                        progress++;
                        progressPercent.textContent = `${progress}%`;
                        progressCircle.style.background = `conic-gradient(#007bff ${progress * 3.6}deg, #e9ecef ${progress * 3.6}deg)`;
                    } else {
                        clearInterval(interval);
                    }
                }, 150);

                setTimeout(() => {
                    complaintForm.submit(); 
            }, 500);
            });
        });
    </script>
</body>
</html>